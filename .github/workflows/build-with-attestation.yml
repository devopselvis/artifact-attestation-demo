name: Build, Attest, and Verify

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# Required permissions for attestations
permissions:
  contents: read
  id-token: write
  attestations: write
  actions: read

jobs:
  build-and-attest:
    runs-on: ubuntu-latest
    outputs:
      artifact-name: ${{ steps.set-artifact-name.outputs.artifact-name }}
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run tests
      run: npm test --if-present
      
    - name: Build package
      run: npm pack
      
    - name: Set artifact name output
      id: set-artifact-name
      run: |
        ARTIFACT_FILE=$(ls *.tgz | head -1)
        echo "artifact-name=$ARTIFACT_FILE" >> $GITHUB_OUTPUT
        echo "üì¶ Created artifact: $ARTIFACT_FILE"
        
    - name: List built artifacts
      run: |
        echo "üìã Built artifacts:"
        ls -la *.tgz
        
    - name: Generate attestation
      uses: actions/attest-build-provenance@v3.0.0
      with:
        subject-path: '*.tgz'
        
    - name: Upload artifact with attestation
      uses: actions/upload-artifact@v4
      with:
        name: npm-package-with-attestation
        path: '*.tgz'
        retention-days: 30

  verify-attestation:
    runs-on: ubuntu-latest
    needs: build-and-attest
    if: always() && needs.build-and-attest.result == 'success'
    
    steps:
    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        name: npm-package-with-attestation
        path: ./downloaded-artifacts
        
    - name: List downloaded artifacts
      run: |
        echo "üìã Downloaded artifacts:"
        ls -la ./downloaded-artifacts/
        
    - name: Move artifacts to current directory
      run: |
        mv ./downloaded-artifacts/*.tgz ./
        echo "üì¶ Artifacts in current directory:"
        ls -la *.tgz
        
    - name: Verify attestation
      run: |
        echo "üîê Verifying attestation for artifact..."
        ARTIFACT_FILE="${{ needs.build-and-attest.outputs.artifact-name }}"
        echo "Verifying: $ARTIFACT_FILE"
        
        # Verify the attestation
        if gh attestation verify "$ARTIFACT_FILE" --repo "${{ github.repository }}"; then
          echo "‚úÖ Attestation verification PASSED!"
        else
          echo "‚ùå Attestation verification FAILED!"
          exit 1
        fi
      env:
        GH_TOKEN: ${{ github.token }}
        
    - name: Get detailed attestation information
      run: |
        echo "üìã Getting detailed attestation information..."
        ARTIFACT_FILE="${{ needs.build-and-attest.outputs.artifact-name }}"
        
        # Get detailed JSON output
        gh attestation verify "$ARTIFACT_FILE" \
          --repo "${{ github.repository }}" \
          --format json > attestation-details.json
          
        echo "üîç Attestation Summary:"
        cat attestation-details.json | jq -r '
          .[0].verificationResult.statement.predicate.buildDefinition as $build |
          "Repository: " + $build.externalParameters.workflow.repository +
          "\nWorkflow: " + $build.externalParameters.workflow.path +
          "\nCommit: " + $build.externalParameters.workflow.ref +
          "\nRunner Environment: " + $build.internalParameters.github.runner_environment +
          "\nBuild Started: " + ($build.runDetails.metadata.startedOn // "N/A") +
          "\nBuild Finished: " + ($build.runDetails.metadata.finishedOn // "N/A")'
      env:
        GH_TOKEN: ${{ github.token }}
        
    - name: Validate attestation claims
      run: |
        echo "üîç Validating specific attestation claims..."
        ARTIFACT_FILE="${{ needs.build-and-attest.outputs.artifact-name }}"
        
        # Extract key information from attestation
        REPO_FROM_ATTESTATION=$(cat attestation-details.json | jq -r '.verificationResult.statement.predicate.buildDefinition.externalParameters.workflow.repository')
        WORKFLOW_FROM_ATTESTATION=$(cat attestation-details.json | jq -r '.verificationResult.statement.predicate.buildDefinition.externalParameters.workflow.path')
        REF_FROM_ATTESTATION=$(cat attestation-details.json | jq -r '.verificationResult.statement.predicate.buildDefinition.externalParameters.workflow.ref')
        
        echo "Validating repository: $REPO_FROM_ATTESTATION"
        echo "Validating workflow: $WORKFLOW_FROM_ATTESTATION"
        echo "Validating ref: $REF_FROM_ATTESTATION"
        
        # Validate repository matches
        if [[ "$REPO_FROM_ATTESTATION" == "${{ github.repository }}" ]]; then
          echo "‚úÖ Repository validation PASSED"
        else
          echo "‚ùå Repository validation FAILED: Expected ${{ github.repository }}, got $REPO_FROM_ATTESTATION"
          exit 1
        fi
        
        # Validate workflow path
        if [[ "$WORKFLOW_FROM_ATTESTATION" == *"build-and-verify-attestation.yml"* ]]; then
          echo "‚úÖ Workflow validation PASSED"
        else
          echo "‚ùå Workflow validation FAILED: Unexpected workflow $WORKFLOW_FROM_ATTESTATION"
          exit 1
        fi
        
        # Validate ref matches current context
        EXPECTED_REF="refs/heads/${{ github.ref_name }}"
        if [[ "${{ github.event_name }}" == "pull_request" ]]; then
          EXPECTED_REF="refs/pull/${{ github.event.number }}/merge"
        fi
        
        echo "Expected ref: $EXPECTED_REF"
        if [[ "$REF_FROM_ATTESTATION" == "$EXPECTED_REF" ]] || [[ "$REF_FROM_ATTESTATION" == "${{ github.ref }}" ]]; then
          echo "‚úÖ Ref validation PASSED"
        else
          echo "‚ö†Ô∏è  Ref validation WARNING: Expected $EXPECTED_REF, got $REF_FROM_ATTESTATION"
          # Don't fail on ref mismatch as it can vary in different contexts
        fi
        
    - name: Upload attestation details
      uses: actions/upload-artifact@v4
      with:
        name: attestation-verification-results
        path: attestation-details.json
        retention-days: 30
        
    - name: Summary
      run: |
        echo "üéâ Attestation verification workflow completed successfully!"
        echo ""
        echo "üìä Summary:"
        echo "- Artifact: ${{ needs.build-and-attest.outputs.artifact-name }}"
        echo "- Repository: ${{ github.repository }}"
        echo "- Commit: ${{ github.sha }}"
        echo "- Workflow: ${{ github.workflow }}"
        echo "- Run ID: ${{ github.run_id }}"
        echo ""
        echo "‚úÖ All attestation validations passed!"
